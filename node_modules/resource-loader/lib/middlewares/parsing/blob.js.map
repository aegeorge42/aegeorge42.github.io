{"version":3,"sources":["../../../src/middlewares/parsing/blob.js"],"names":["blobMiddlewareFactory","Url","window","URL","webkitURL","blobMiddleware","resource","next","data","xhr","xhrType","Resource","XHR_RESPONSE_TYPE","BLOB","Blob","type","getResponseHeader","indexOf","Image","src","responseText","TYPE","IMAGE","onload","createObjectURL","blob","revokeObjectURL"],"mappings":";;;QAMgBA,qB,GAAAA,qB;;AANhB;;AACA;;AAEA,IAAMC,MAAMC,OAAOC,GAAP,IAAcD,OAAOE,SAAjC;;AAEA;AACO,SAASJ,qBAAT,GAAiC;AACpC,WAAO,SAASK,cAAT,CAAwBC,QAAxB,EAAkCC,IAAlC,EAAwC;AAC3C,YAAI,CAACD,SAASE,IAAd,EAAoB;AAChBD;;AAEA;AACH;;AAED;AACA,YAAID,SAASG,GAAT,IAAgBH,SAASI,OAAT,KAAqBC,mBAASC,iBAAT,CAA2BC,IAApE,EAA0E;AACtE;AACA,gBAAI,CAACX,OAAOY,IAAR,IAAgB,OAAOR,SAASE,IAAhB,KAAyB,QAA7C,EAAuD;AACnD,oBAAMO,OAAOT,SAASG,GAAT,CAAaO,iBAAb,CAA+B,cAA/B,CAAb;;AAEA;AACA,oBAAID,QAAQA,KAAKE,OAAL,CAAa,OAAb,MAA0B,CAAtC,EAAyC;AACrCX,6BAASE,IAAT,GAAgB,IAAIU,KAAJ,EAAhB;AACAZ,6BAASE,IAAT,CAAcW,GAAd,aAA4BJ,IAA5B,gBAA2C,qBAAaT,SAASG,GAAT,CAAaW,YAA1B,CAA3C;;AAEAd,6BAASS,IAAT,GAAgBJ,mBAASU,IAAT,CAAcC,KAA9B;;AAEA;AACAhB,6BAASE,IAAT,CAAce,MAAd,GAAuB,YAAM;AACzBjB,iCAASE,IAAT,CAAce,MAAd,GAAuB,IAAvB;;AAEAhB;AACH,qBAJD;;AAMA;AACA;AACH;AACJ;AACD;AArBA,iBAsBK,IAAID,SAASE,IAAT,CAAcO,IAAd,CAAmBE,OAAnB,CAA2B,OAA3B,MAAwC,CAA5C,EAA+C;AAChD,wBAAME,MAAMlB,IAAIuB,eAAJ,CAAoBlB,SAASE,IAA7B,CAAZ;;AAEAF,6BAASmB,IAAT,GAAgBnB,SAASE,IAAzB;AACAF,6BAASE,IAAT,GAAgB,IAAIU,KAAJ,EAAhB;AACAZ,6BAASE,IAAT,CAAcW,GAAd,GAAoBA,GAApB;;AAEAb,6BAASS,IAAT,GAAgBJ,mBAASU,IAAT,CAAcC,KAA9B;;AAEA;AACA;AACAhB,6BAASE,IAAT,CAAce,MAAd,GAAuB,YAAM;AACzBtB,4BAAIyB,eAAJ,CAAoBP,GAApB;AACAb,iCAASE,IAAT,CAAce,MAAd,GAAuB,IAAvB;;AAEAhB;AACH,qBALD;;AAOA;AACA;AACH;AACJ;;AAEDA;AACH,KAxDD;AAyDH","file":"blob.js","sourcesContent":["import { Resource } from '../../Resource';\nimport { encodeBinary } from '../../b64';\n\nconst Url = window.URL || window.webkitURL;\n\n// a middleware for transforming XHR loaded Blobs into more useful objects\nexport function blobMiddlewareFactory() {\n    return function blobMiddleware(resource, next) {\n        if (!resource.data) {\n            next();\n\n            return;\n        }\n\n        // if this was an XHR load of a blob\n        if (resource.xhr && resource.xhrType === Resource.XHR_RESPONSE_TYPE.BLOB) {\n            // if there is no blob support we probably got a binary string back\n            if (!window.Blob || typeof resource.data === 'string') {\n                const type = resource.xhr.getResponseHeader('content-type');\n\n                // this is an image, convert the binary string into a data url\n                if (type && type.indexOf('image') === 0) {\n                    resource.data = new Image();\n                    resource.data.src = `data:${type};base64,${encodeBinary(resource.xhr.responseText)}`;\n\n                    resource.type = Resource.TYPE.IMAGE;\n\n                    // wait until the image loads and then callback\n                    resource.data.onload = () => {\n                        resource.data.onload = null;\n\n                        next();\n                    };\n\n                    // next will be called on load\n                    return;\n                }\n            }\n            // if content type says this is an image, then we should transform the blob into an Image object\n            else if (resource.data.type.indexOf('image') === 0) {\n                const src = Url.createObjectURL(resource.data);\n\n                resource.blob = resource.data;\n                resource.data = new Image();\n                resource.data.src = src;\n\n                resource.type = Resource.TYPE.IMAGE;\n\n                // cleanup the no longer used blob after the image loads\n                // TODO: Is this correct? Will the image be invalid after revoking?\n                resource.data.onload = () => {\n                    Url.revokeObjectURL(src);\n                    resource.data.onload = null;\n\n                    next();\n                };\n\n                // next will be called on load.\n                return;\n            }\n        }\n\n        next();\n    };\n}\n"]}